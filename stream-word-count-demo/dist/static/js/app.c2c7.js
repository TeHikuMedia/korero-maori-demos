webpackJsonp([1],{BLBT:function(t,i){api_auth={headers:{Authorization:"Token YOUR_TOKEN_HERE"},url:"https://koreromaori.io/api/transcription/?method=stream"},i.api_auth=api_auth},IQ7y:function(t,i){},NHnr:function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var s=e("7+uW");e("BLBT").api_auth;var o={name:"Kōrero",data:()=>({vadOn:!1,recordingOn:!1,recorder:null,buttonText:"Start",transcriptions:[],icon:"fa-microphone",loadRecording:!1,te_reo_sensivity:85,vad_sensitivity:10,sensitivity_max:100,status:"",totalCount:0}),methods:{deleteObject:function(t){this.transcriptions.splice(t,1)},stopRecording:function(){try{this.recorder.stop()}catch(t){}this.recorder=null,this.vadOn=!1,this.recordingOn=!1},isMobile:()=>!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Mobile|SamsungBrowser|Opera Mini/i.test(navigator.userAgent)&&(console.log(navigator.userAgent),!0),setTeReoSensivity:function(t){if(this.te_reo_sensivity=t.target.value,1==this.sensitivity_sock.readyState){var i=""+parseInt(this.te_reo_sensivity)/this.sensitivity_max;this.sensitivity_sock.send(i)}},setVadSensivity:function(t){this.vad_sensitivity=t.target.value},processResult:function(t){var i=this.transcriptions[0];i&&("EOS"==t?(i.total_count=i.total_count+i.active_count,i.active_count=0):(i.active_count=parseInt(t),i.status="Success"),this.animateCount())},animateCount:function(){var t=this.transcriptions[0];if(t){if(t.display_count==t.total_count)return void(t.active=!1);t.display_count<t.total_count&&(t.display_count+=1,t.active=!0),t.display_count>t.display_count&&(t.display_count-=1,t.active=!0),setTimeout(this.animateCount,150)}},initWebSocket:function(){var t="wss://asr-dev.koreromaori.io/word_count";this.status="Connecting to "+t,this.socket=new WebSocket(t),this.socket.binaryType="arraybuffer";var i=this;this.socket.onmessage=function(e){i.status="Connected to  "+t,e.isTrusted&&i.processResult(e.data)},this.socket.onclose=function(){i.status="Last connected "+t,console.log("Connection to server closed")},this.socket.onerror=function(t){i.status="Error getting data "+t,console.log("Getting audio data error:",t)}},ensureWebSocket:function(){if(self=this,null==this.socket)this.initWebSocket();else{var t=this.socket.readyState;t==WebSocket.CLOSED&&this.initWebSocket(),t==WebSocket.CLOSING&&(this.socket.onclose=function(){self.initWebSocket()})}},initSensitivitySocket:function(){var t="wss://asr-dev.koreromaori.io/word_count_sensitivity";console.log("Connecting to "+t),this.sensitivity_sock=new WebSocket(t),this.sensitivity_sock.binaryType="arraybuffer",this.sensitivity_sock.onmessage=function(i){console.log("Connected to  "+t)}}},mounted:function(){this.initSensitivitySocket(),startVAD.onclick=(t=>{if(null==this.recorder){this.loadRecording=!0;this.transcriptions.unshift({status:"Transcribing",display_count:0,total_count:0,active_count:0}),this.initWebSocket(),this.recorder=new class{constructor(t={}){this.beforeRecording=t.beforeRecording,this.pauseRecording=t.pauseRecording,this.processAudio=t.processAudio,this.afterRecording=t.afterRecording,this.micFailed=t.micFailed,this.voiceStop=t.voiceStop,this.voiceStart=t.voiceStart,this.visCanvasID=t.canvasID||null,this.bitRate=t.bitRate||96,this.sampleRate=t.sampleRate||16e3,this.bufferSize=4096,this.records=[],this.sampler=new class{constructor(t,i,e,s,o){this.fromSampleRate=t,this.toSampleRate=i,this.channels=0|e,this.outputBufferSize=s,this.noReturn=!!o,this.initialize()}initialize(){if(!(this.fromSampleRate>0&&this.toSampleRate>0&&this.channels>0))throw new Error("Invalid settings specified for the resampler.");this.fromSampleRate==this.toSampleRate?(this.resampler=this.bypassResampler,this.ratioWeight=1):(this.compileInterpolationFunction(),this.resampler=this.interpolate,this.ratioWeight=this.fromSampleRate/this.toSampleRate,this.tailExists=!1,this.lastWeight=0,this.initializeBuffers())}compileInterpolationFunction(){for(var t="var bufferLength = Math.min(buffer.length, this.outputBufferSize);        if ((bufferLength % "+this.channels+") == 0) {            if (bufferLength > 0) {                var ratioWeight = this.ratioWeight;                var weight = 0;",i=0;i<this.channels;++i)t+="var output"+i+" = 0;";for(t+="var actualPosition = 0;                var amountToNext = 0;                var alreadyProcessedTail = !this.tailExists;                this.tailExists = false;                var outputBuffer = this.outputBuffer;                var outputOffset = 0;                var currentPosition = 0;                do {                    if (alreadyProcessedTail) {                        weight = ratioWeight;",i=0;i<this.channels;++i)t+="output"+i+" = 0;";for(t+="}                    else {                        weight = this.lastWeight;",i=0;i<this.channels;++i)t+="output"+i+" = this.lastOutput["+i+"];";for(t+="alreadyProcessedTail = true;                    }                    while (weight > 0 && actualPosition < bufferLength) {                        amountToNext = 1 + actualPosition - currentPosition;                        if (weight >= amountToNext) {",i=0;i<this.channels;++i)t+="output"+i+" += buffer[actualPosition++] * amountToNext;";for(t+="currentPosition = actualPosition;                            weight -= amountToNext;                        }                        else {",i=0;i<this.channels;++i)t+="output"+i+" += buffer[actualPosition"+(i>0?" + "+i:"")+"] * weight;";for(t+="currentPosition += weight;                            weight = 0;                            break;                        }                    }                    if (weight == 0) {",i=0;i<this.channels;++i)t+="outputBuffer[outputOffset++] = output"+i+" / ratioWeight;";for(t+="}                    else {                        this.lastWeight = weight;",i=0;i<this.channels;++i)t+="this.lastOutput["+i+"] = output"+i+";";t+='this.tailExists = true;                        break;                    }                } while (actualPosition < bufferLength);                return this.bufferSlice(outputOffset);            }            else {                return (this.noReturn) ? 0 : [];            }        }        else {            throw(new Error("Buffer was of incorrect sample length."));        }',this.interpolate=Function("buffer",t)}bypassResampler(t){return this.noReturn?(this.outputBuffer=t,t.length):t}bufferSlice(t){if(this.noReturn)return t;try{return this.outputBuffer.subarray(0,t)}catch(i){try{return this.outputBuffer.length=t,this.outputBuffer}catch(i){return this.outputBuffer.slice(0,t)}}}initializeBuffers(t){try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(t){this.outputBuffer=[],this.lastOutput=[]}}}(this.sampleRate,16e3,1,this.bufferSize),this.isPause=!1,this.isRecording=!1,this.volume=0,this.vad=null,this.vis=null,this.activity=!1,this.vis=null,this.context=new(window.AudioContext||window.webkitAudioContext),this.sampleRate=this.context.sampleRate,this.context.close()}start(){this.beforeRecording&&this.beforeRecording("start recording"),navigator.mediaDevices.getUserMedia({video:!1,audio:{channelCount:1,echoCancellation:!0}}).then(this._micCaptured.bind(this)).catch(this._micError.bind(this)),this.isPause=!1,this.isRecording=!0}stop(){this.vis&&this.vis.stop(),this.processor&&this.processor.disconnect(),this.context&&this.context.close(),this.isPause=!1,this.isRecording=!1}pause(){this.stream.getTracks().forEach(t=>t.stop()),this.input.disconnect(),this.processor.disconnect(),this.context.close(),this.isPause=!0,this.pauseRecording&&this.pauseRecording("pause recording")}recordList(){return this.records}lastRecord(){return this.records.slice(-1)}_floatTo16BitPCM(t,i){for(let e=0;e<t.length;e++){const s=Math.max(-1,Math.min(1,t[e]));i[e]=s<0?32768*s:32767*s}}_convertTo16BitPCM(t){const i=new Float32Array(t),e=new Int16Array(t.length);return this._floatTo16BitPCM(i,e),e}_micCaptured(t){this.context=new(window.AudioContext||window.webkitAudioContext)({sampleRate:this.sampleRate}),this.input=this.context.createMediaStreamSource(t),this.processor=this.context.createScriptProcessor(this.bufferSize,1,1),this.stream=t,this._voiceStop=(()=>{this.voiceStop(),this.activity=!1,this.afterRecording&&this.afterRecording()}),this._voiceStart=(()=>{this.voiceStart(),this.activity=!0});var i={debug:!1,source:this.input,voice_stop:this._voiceStop,voice_start:this._voiceStart};if(this.vad=new class{constructor(t){for(var i in this.options={fftSize:256,bufferLen:256,voice_stop:function(){},voice_start:function(){},smoothingTimeConstant:.99,energy_offset:1e-8,energy_threshold_ratio_pos:4,energy_threshold_ratio_neg:.25,energy_integration:1,filter:[{f:200,v:0},{f:2e3,v:1}],source:null,context:null,debug:!1},t)t.hasOwnProperty(i)&&(this.options[i]=t[i]);if(!this.options.source)throw new Error("The options must specify a MediaStreamAudioSourceNode.");this.options.context=this.options.source.context,this.hertzPerBin=this.options.context.sampleRate/this.options.fftSize,this.iterationFrequency=this.options.context.sampleRate/this.options.bufferLen,this.iterationPeriod=1/this.iterationFrequency,this.options.debug&&console.log("Vad | sampleRate: "+this.options.context.sampleRate+" | hertzPerBin: "+this.hertzPerBin+" | iterationFrequency: "+this.iterationFrequency+" | iterationPeriod: "+this.iterationPeriod),this.setFilter=function(t){this.filter=[];for(var i=0,e=this.options.fftSize/2;i<e;i++){this.filter[i]=0;for(var s=0,o=t.length;s<o;s++)if(i*this.hertzPerBin<t[s].f){this.filter[i]=t[s].v;break}}},this.setFilter(this.options.filter),this.ready={},this.vadState=!1,this.energy_offset=this.options.energy_offset,this.energy_threshold_pos=this.energy_offset*this.options.energy_threshold_ratio_pos,this.energy_threshold_neg=this.energy_offset*this.options.energy_threshold_ratio_neg,this.voiceTrend=0,this.voiceTrendMax=15,this.voiceTrendMin=-5,this.voiceTrendStart=2,this.voiceTrendEnd=-5,this.damper=.02,this.voiceTrendMin=this.voiceTrendEnd-this.damper/10,this.analyser=this.options.context.createAnalyser(),this.analyser.smoothingTimeConstant=this.options.smoothingTimeConstant,this.analyser.fftSize=this.options.fftSize,this.floatFrequencyData=new Float32Array(this.analyser.frequencyBinCount),this.floatFrequencyDataLinear=new Float32Array(this.floatFrequencyData.length),this.options.source.connect(this.analyser),this.scriptProcessorNode=this.options.context.createScriptProcessor(this.options.bufferLen,1,1),this.scriptProcessorNode.connect(this.options.context.destination);var e=this;this.scriptProcessorNode.onaudioprocess=function(t){e.analyser.getFloatFrequencyData(e.floatFrequencyData),e.update(),e.monitor()},this.options.source.connect(this.scriptProcessorNode),this.logging=!1,this.log_i=0,this.log_limit=100,this.triggerLog=function(t){this.logging=!0,this.log_i=0,this.log_limit="number"==typeof t?t:this.log_limit},this.log=function(t){this.logging&&this.log_i<this.log_limit?(this.log_i++,console.log(t)):this.logging=!1},this.update=function(){for(var t=this.floatFrequencyData,i=0,e=t.length;i<e;i++)this.floatFrequencyDataLinear[i]=Math.pow(10,t[i]/10);this.ready={}},this.getEnergy=function(){if(this.ready.energy)return this.energy;for(var t=0,i=this.floatFrequencyDataLinear,e=0,s=i.length;e<s;e++)t+=this.filter[e]*i[e]*i[e];return this.energy=t,this.ready.energy=!0,t},this.monitor=function(){var t=this.getEnergy(),i=t-this.energy_offset;i>this.energy_threshold_pos?this.voiceTrend=this.voiceTrend+1>this.voiceTrendMax?this.voiceTrendMax:this.voiceTrend+1:i<-this.energy_threshold_neg?this.voiceTrend=this.voiceTrend-1<this.voiceTrendMin?this.voiceTrendMin:this.voiceTrend-1*(this.vadState?this.damper:10):this.voiceTrend>0?this.voiceTrend--:this.voiceTrend<0&&this.voiceTrend++;var e=!1,s=!1;this.voiceTrend>this.voiceTrendStart?e=!0:this.voiceTrend<this.voiceTrendEnd&&(s=!0);var o=i*this.iterationPeriod*this.options.energy_integration;return this.energy_offset+=o>0||!s?o:10*o,this.energy_offset=this.energy_offset<0?0:this.energy_offset,this.energy_threshold_pos=this.energy_offset*this.options.energy_threshold_ratio_pos,this.energy_threshold_neg=this.energy_offset*this.options.energy_threshold_ratio_neg,e&&!this.vadState&&(this.vadState=!0,this.options.voice_start()),s&&this.vadState&&(this.vadState=!1,this.options.voice_stop()),this.log("e: "+t+" | e_of: "+this.energy_offset+" | e+_th: "+this.energy_threshold_pos+" | e-_th: "+this.energy_threshold_neg+" | signal: "+i+" | int: "+o+" | voiceTrend: "+this.voiceTrend+" | start: "+e+" | end: "+s),i}}}(i),this.visCanvasID)try{this.vis=new class{constructor(t,i,e){this.canvas=document.getElementById(t),this.canvasContext=this.canvas.getContext("2d"),this.loop=!1,this.sourceNode=i,this.audioContext=e,this.analyser=e.createAnalyser(),this.analyser.fftSize=32,this.sourceNode.connect(this.analyser),this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.analyser.fftSize)}stop(){this.loop=!1;var t=this;window.setTimeout(function(){t.clearFrame()},200)}start(){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.WIDTH=this.canvas.clientWidth,this.HEIGHT=this.canvas.clientHeight,this.loop=!0,this.renderFrame()}renderFrame(){var t=this;if(t.loop){window.requestAnimationFrame(function(){t.renderFrame()}),t.analyser.getByteFrequencyData(t.dataArray),t.canvasContext.fillStyle="#333",t.canvasContext.fillRect(0,0,t.WIDTH,t.HEIGHT);for(var i=parseInt(t.WIDTH/t.bufferLength),e=0,s=0,o=0;o<t.bufferLength/2;o++){e=parseInt(t.dataArray[o]/255*t.HEIGHT*.9);var n=parseInt(t.HEIGHT/e*.5*73),r=parseInt(e/t.HEIGHT*90);t.canvasContext.fillStyle="hsl(345,"+n+"%,"+r+"%)",t.canvasContext.fillRect(2*s+1,t.HEIGHT-e,2*i-2,e),s+=i}}}clearFrame(){this.canvasContext.clearRect(0,0,this.WIDTH,this.HEIGHT),this.canvasContext.fillStyle="#333",this.canvasContext.fillRect(0,0,this.WIDTH,this.HEIGHT)}}(this.visCanvasID,this.input,this.input.context),this.vis.start()}catch(t){console.log(t)}this.processor.onaudioprocess=(t=>{var i=t.inputBuffer.getChannelData(0);let e=0;for(let t=0;t<i.length;++t)e+=i[t]*i[t];if(this.volume=Math.sqrt(e/i.length).toFixed(2),this.activity&&this.processAudio){var s=this.sampler.resampler(i),o=this._convertTo16BitPCM(s);this.processAudio(o)}}),this.input.connect(this.processor),this.processor.connect(this.context.destination)}_micError(t){this.micFailed&&this.micFailed(t)}}({processAudio:t=>{1==this.socket.readyState&&this.socket.send(t)},afterRecording:t=>{1==this.socket.readyState&&this.socket.send("EOS")},pauseRecording:()=>{streamer.stop(),console.log("paused")},micFailed:()=>{console.log("failed")},voiceStop:()=>{this.vadOn=!1},voiceStart:()=>{this.vadOn=!0,this.ensureWebSocket()},canvasID:this.isMobile()?null:"canvas",bitRate:64,sampleRate:44100})}this.recordingOn?(this.recorder.stop(),this.recorder=null,this.vadOn=!1,this.recordingOn=!1):(this.recorder.start(),this.recordingOn=!0,this.buttonText="Stop",this.loadRecording=!1)})}},n={render:function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"Korero"},[e("div",{staticClass:"header"},[e("h4",[t._v("Kōrero Māori Word Count (Demo))")]),t._v(" "),e("button",{class:{vad:t.vadOn,on:t.recordingOn,loading:t.loadRecording},attrs:{id:"startVAD"}},[e("i",{staticClass:"fa fa-microphone"}),t._v(" "),e("i",{staticClass:"fa fa-stop"}),t._v(" "),e("i",{staticClass:"fa fa-spinner fa-spin"})]),t._v(" "),e("div",{class:{active:t.vadOn,mobile:t.isMobile()},attrs:{id:"vadStatus"}},[e("div",[t.isMobile()?t._e():e("canvas",{attrs:{id:"canvas"}}),t._v(" "),t.isMobile()&&t.vadOn&&t.recordingOn?e("span",[t._v("Voice Detected")]):t._e(),t._v(" "),t.isMobile()&&t.recordingOn&&!t.vadOn?e("span",[t._v("Listening")]):t._e(),t._v(" "),t.isMobile()?e("span",[t._v("Hit Record")]):t._e()])]),t._v(" "),e("div",{staticClass:"sensitivity_box",attrs:{id:"te_reo_sensivity"}},[t._v("\n        Sensitivity:\n        "),e("input",{attrs:{type:"range",min:"0",max:t.sensitivity_max},domProps:{value:t.te_reo_sensivity},on:{input:function(i){return t.setTeReoSensivity(i)}}}),t._v("\n          "+t._s(t.te_reo_sensivity)+"\n      ")])]),t._v(" "),e("div",{staticClass:"body"},[e("div",{attrs:{id:"transcriptions"}},t._l(t.transcriptions,function(i,s){return"Failed"!=i.status?e("div",{staticClass:"transcription",class:[i.status]},["Transcribing"!=i.status?e("button",{staticClass:"delete",on:{click:function(i){return t.deleteObject(s)}}},[e("i",{staticClass:"fa fa-times"})]):t._e(),t._v(" "),e("div",{staticClass:"text"},["Transcribing"==i.status?e("i",{staticClass:"fa fa-spinner fa-spin",class:[i.status]}):t._e(),t._v(" "),"Transcribing"!=i.status?e("div",[t._v(t._s(i.display_count))]):t._e()])]):t._e()}),0)]),t._v(" "),e("div",{staticClass:"footer"},[e("div",{staticClass:"status"},[t._v(" "+t._s(t.status))])])])},staticRenderFns:[]};var r=e("VU/8")(o,n,!1,function(t){e("IQ7y")},"data-v-5b66ebaa",null).exports,a=e("PXmv");s.a.use(a.a),s.a.customElement("vue-widget",r)}},["NHnr"]);
//# sourceMappingURL=app.c2c7.js.map